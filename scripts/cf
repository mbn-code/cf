#!/bin/bash

################################################################################
# cf - Codeforces CLI Tool
#
# Main command-line interface for C++ competitive programming
#
# Usage:
#   cf template <name>         - Create new problem template
#   cf <name> [input]          - Compile and run solution
#
# Examples:
#   cf template 1000A          - Create src/1000A/ with solution.cpp
#   cf 1000A input.txt         - Compile and run with input.txt
#   cf 1000A "5\n1 2 3 4 5"    - Compile and run with inline input
#
# Features:
#   - Auto-detects .cpp files
#   - Handles multi-file compilation
#   - Fast I/O configuration
#   - Cross-platform (Linux/macOS/WSL)
#   - Idempotent and robust
#
################################################################################

set -e

# ==================== CONFIGURATION ====================

# Determine repository root
if [ -f "${BASH_SOURCE[0]}" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    # If script is in the repo's scripts/ directory, use it
    if [ -f "$SCRIPT_DIR/../src/template.cpp" ]; then
        REPO_ROOT="$(dirname "$SCRIPT_DIR")"
    # Otherwise, use HOME-based fallback for global installation
    else
        REPO_ROOT="${CF_REPO_ROOT:-$HOME/Documents/GitHub/cf}"
    fi
else
    REPO_ROOT="${CF_REPO_ROOT:-$HOME/Documents/GitHub/cf}"
fi

SRC_DIR="$REPO_ROOT/src"
INCLUDE_DIR="$REPO_ROOT/include"

# Compiler selection: prefer g++, fall back to clang++
if command -v g++ &> /dev/null; then
    COMPILER="g++"
elif command -v clang++ &> /dev/null; then
    COMPILER="clang++"
else
    echo "Error: No C++ compiler found. Install g++ or clang++."
    exit 1
fi

# Compiler flags for competitive programming
CXXFLAGS="-std=c++23 -O2 -Wall -Wextra"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# ==================== HELPER FUNCTIONS ====================

print_error() {
    echo -e "${RED}Error: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ $1${NC}"
}

# Find .cpp files in a directory
find_cpp_files() {
    local dir="$1"
    find "$dir" -maxdepth 1 -name "*.cpp" -type f
}

# Check if directory exists
dir_exists() {
    [ -d "$1" ]
}

# Extract test input from problem description file
# Looks for "Input" section under "Examples" and extracts until "Output"
extract_test_input() {
    local file="$1"
    local content=$(cat "$file")
    
    # Check if this looks like a problem description with Examples section
    if echo "$content" | grep -qi "Examples"; then
        # Extract input between "Input" (after Examples) and "Output"
        # Using awk to find the pattern and extract the input
        awk '
            BEGIN { in_input = 0; in_example = 0 }
            /Examples/ { in_example = 1; next }
            in_example && /^Input$/ { in_input = 1; next }
            in_example && /^Copy$/ && in_input { next }
            in_example && in_input && /^Output$/ { exit }
            in_example && in_input && /^Copy$/ { exit }
            in_example && in_input && NF > 0 { print }
        ' "$file"
    else
        # Regular input file, return as-is
        cat "$file"
    fi
}

# ==================== TEMPLATE COMMAND ====================

cmd_template() {
    local problem_name="$1"
    
    if [ -z "$problem_name" ]; then
        print_error "Usage: cf template <name>"
        echo "Example: cf template 1000A"
        exit 1
    fi
    
    # Create problem directory in current working directory
    local problem_dir="$PWD/$problem_name"
    
    if dir_exists "$problem_dir"; then
        print_info "Problem directory already exists: $problem_dir"
    else
        mkdir -p "$problem_dir"
        print_success "Created directory: $problem_dir"
    fi
    
    # Copy template to solution.cpp
    local solution_file="$problem_dir/solution.cpp"
    
    if [ -f "$solution_file" ]; then
        print_info "Solution already exists: $solution_file"
    else
        if [ -f "$SRC_DIR/template.cpp" ]; then
            cp "$SRC_DIR/template.cpp" "$solution_file"
            print_success "Created solution: $solution_file"
        else
            print_error "Template file not found: $SRC_DIR/template.cpp"
            exit 1
        fi
    fi
    
    # Create problem.txt file
    local problem_file="$problem_dir/problem.txt"
    
    if [ -f "$problem_file" ]; then
        print_info "Problem file already exists: $problem_file"
    else
        cat > "$problem_file" << 'EOF'
# Paste the problem statement here from Codeforces

Examples
Input


Output


EOF
        print_success "Created problem file: $problem_file"
    fi
    
    # Compile to verify setup
    print_info "Verifying compilation..."
    local output_file="/tmp/cf_$problem_name$$"
    
    if $COMPILER $CXXFLAGS -I "$INCLUDE_DIR" "$solution_file" -o "$output_file" 2>/dev/null; then
        print_success "Compilation verified"
        rm -f "$output_file"
    else
        print_error "Compilation failed. Check your C++ compiler."
        exit 1
    fi
    
    # Open files in VS Code if available
    if command -v code &> /dev/null; then
        print_info "Opening files in VS Code..."
        code "$problem_file" "$solution_file"
        print_success "Opened in VS Code"
    fi
    
    echo ""
    echo "Next steps:"
    echo "  1. Paste problem statement in problem.txt"
    echo "  2. Edit solution in solution.cpp"
    echo "  3. cd $problem_name && cf problem.txt"
}

# ==================== RUN COMMAND ====================

cmd_run() {
    local input_arg="$1"
    
    # Find .cpp file in current directory
    local cpp_file=""
    
    # First, look for solution.cpp in current directory
    if [ -f "$PWD/solution.cpp" ]; then
        cpp_file="$PWD/solution.cpp"
    else
        # Otherwise, find any .cpp file in current directory
        cpp_file=$(find "$PWD" -maxdepth 1 -name "*.cpp" -type f | head -1)
    fi
    
    if [ -z "$cpp_file" ]; then
        print_error "No C++ file found in current directory"
        echo "Searched in: $PWD"
        exit 1
    fi
    
    print_info "Using: $(basename "$cpp_file")"
    
    # Prepare output file
    local output_file="/tmp/cf_$(basename "$cpp_file" .cpp)$$"
    
    # Compile
    print_info "Compiling with $COMPILER..."
    if ! $COMPILER $CXXFLAGS -I "$INCLUDE_DIR" "$cpp_file" -o "$output_file" 2>&1; then
        print_error "Compilation failed"
        exit 1
    fi
    print_success "Compiled successfully"
    
    # Prepare input
    local input_data=""
    
    if [ -n "$input_arg" ]; then
        if [ -f "$input_arg" ]; then
            # Input is a file - extract test input intelligently
            print_info "Running with input from: $input_arg"
            input_data=$(extract_test_input "$input_arg")
        else
            # Input is a string (possibly with escaped newlines)
            print_info "Running with inline input"
            # Interpret escape sequences
            input_data=$(printf "%b" "$input_arg")
        fi
    else
        print_info "Running with stdin (pipe input or interactive)"
    fi
    
    # Execute with input
    echo ""
    print_info "Output:"
    echo "---"
    
    if [ -n "$input_data" ]; then
        echo -n "$input_data" | "$output_file"
    else
        "$output_file"
    fi
    
    echo "---"
    
    # Cleanup
    rm -f "$output_file"
    
    print_success "Execution complete"
}

# ==================== MAIN ENTRY POINT ====================

main() {
    # Validate repo structure
    if [ ! -d "$SRC_DIR" ]; then
        print_error "Repository structure not found. Expected $SRC_DIR"
        exit 1
    fi
    
    # Parse command
    local command="${1:-}"
    shift || true
    
    case "$command" in
        template)
            cmd_template "$@"
            ;;
        "")
            print_error "Usage: cf <command> [args]"
            echo ""
            echo "Commands:"
            echo "  template <name>    Create new problem template"
            echo "  [input]            Compile and run solution in current directory"
            echo ""
            echo "Examples:"
            echo "  cf template 1000A"
            echo "  cf 8               Run with inline input '8'"
            echo "  cf input.txt       Run with input from file"
            exit 1
            ;;
        *)
            cmd_run "$command" "$@"
            ;;
    esac
}

main "$@"
